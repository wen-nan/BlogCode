---
author: "Narcissus"
title: "MySQL:事务"
date: "2021-11-30"
description: "学习MySQL45讲事务相关知识。"
tags: ["MySQL"]
categories: ["MySQL"]
---

## 事务隔离：为什么你改了我还看不见？

**事务支持是在引擎层实现的**，MySQL是支持多引擎的系统，但并不是所有引擎都支持事务。

### 隔离性与隔离级别

事务的特性有ACID（Atomicity、Consistency、Isolation、Durability，即原子性、一致性、隔离性、持久性）。

当数据库多个事务同时执行的时候，就可能出现脏读、不可重复读、幻读的问题，为了解决这些问题，就有了隔离级别的概念。SQL标准事务隔离级别包括：

- 读未提交：一个事务还没提交时，他做的变更就能被别的事务看到。
- 读提交：一个事务提交后，他做的变更才会被其他事务看到。
- 可重复读：一个事务执行过程中看到的数据，总是跟这个事务启动时看到的数据保持一致。
- 串行化：对同一行记录，读写都会加锁。

> 在实现上，**数据库会创建一个视图，访问的时候以视图的逻辑结果为准**。
>
> - 在“可重复读”隔离级别下，视图在事务启动时创建，整个事务存在期间都用这个视图。
> - 在“读提交”隔离级别下，视图在每个SQL语句开始执行的时候创建。
> - “读未提交”隔离级别下直接返回记录上的最新值，没有视图概念。
> - “串行化”隔离级别下直接用加锁的方式避免并行访问。

### 事务隔离的实现

**事务隔离通过回滚日志实现**，在MySQL中，每一条记录在更新的时候都会记录一条回滚操作，假设一个值从1被顺序改成了2、3、4，在回滚日志里面有类似下面的记录：

![ScreenShot2021-11-20 18.36.53](https://narcissusblog-img.oss-cn-beijing.aliyuncs.com/uPic/file-11/ScreenShot2021-11-20%2018.36.53.png)

在视图A、B、C中，这个记录的值分别是1、2、4，**同一条记录在系统中可以存在多个版本，这就是数据库的多版本并发控制（MVCC）**。

> 注意：当系统里没有比回滚日志更早的read-view时，回滚日志就会被删除。因此我们应该尽量避免使用长事务，因为会导致大量占用存储空间。
